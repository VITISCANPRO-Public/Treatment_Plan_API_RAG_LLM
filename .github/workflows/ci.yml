name: CI/CD — Treatment Plan API

# ── Triggers ──────────────────────────────────────────────────────────────────
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  push:
    branches:
      - main

# ═════════════════════════════════════════════════════════════════════════════
# JOB 1 — Unit tests (pure functions, no external services)
# ═════════════════════════════════════════════════════════════════════════════
jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run unit tests
        run: pytest tests/test_units.py -v --tb=short

# ═════════════════════════════════════════════════════════════════════════════
# JOB 2 — Integration tests (endpoints with mocked RAG pipeline)
# ═════════════════════════════════════════════════════════════════════════════
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests            # only runs if unit tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run integration tests
        # No real Weaviate or HuggingFace needed — generate_treatment_advice is mocked
        run: |
          export PYTHONPATH=.
          pytest tests/ -v --tb=short

# ═════════════════════════════════════════════════════════════════════════════
# JOB 3 — Deploy to HuggingFace Spaces
# Only runs on push to main AND only if both test jobs pass
# ═════════════════════════════════════════════════════════════════════════════
  deploy:
    name: Deploy to HuggingFace Spaces
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]   # both jobs must pass
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # full history needed for git push
          lfs: true             # fetch large files if any

      - name: Push to HuggingFace Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME:   ${{ vars.HF_USERNAME }}
          HF_SPACE_NAME: ${{ vars.HF_SPACE_NAME }}
        run: |
          git config user.email "ci@vitiscan.ai"
          git config user.name  "Vitiscan CI"
          git push \
            https://$HF_USERNAME:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$HF_SPACE_NAME \
            main